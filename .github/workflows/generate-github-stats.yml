name: Generate GitHub Stats SVGs
on:
  push:
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * *'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Generate SVGs
        env:
          USERNAME: nikelroid
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python - <<'PY'
          import os, requests
          token = os.getenv("GITHUB_TOKEN")
          user = os.getenv("USERNAME")
          headers = {"Authorization": f"token {token}"} if token else {}
          s = requests.Session()
          s.headers.update(headers)

          u = s.get(f"https://api.github.com/users/{user}").json()
          followers = u.get("followers", 0)
          public_repos = u.get("public_repos", 0)

          repos, page = [], 1
          while True:
            r = s.get(f"https://api.github.com/users/{user}/repos?per_page=100&page={page}").json()
            if not r:
              break
            repos += r
            page += 1

          stars = sum(repo.get("stargazers_count", 0) for repo in repos)

          lang_bytes = {}
          for repo in repos:
            url = repo.get("languages_url")
            if not url:
              continue
            for k, v in s.get(url).json().items():
              lang_bytes[k] = lang_bytes.get(k, 0) + v

          stats_svg = f'''<svg xmlns="http://www.w3.org/2000/svg" width="540" height="120">
            <style>.bg{{fill:#0b1020}} .txt{{font-family:Segoe UI, Arial; fill:#fff}}</style>
            <rect rx="10" width="100%" height="100%" class="bg"/>
            <g class="txt" font-size="16">
              <text x="20" y="35">Followers: {followers}</text>
              <text x="20" y="60">Public repos: {public_repos}</text>
              <text x="20" y="85">Total stars: {stars}</text>
            </g>
          </svg>'''
          open("github-stats.svg", "w").write(stats_svg)

          total = sum(lang_bytes.values()) or 1
          top = sorted(lang_bytes.items(), key=lambda x: -x[1])[:6]
          y, lines = 30, []
          for lang, b in top:
            pct = round((b / total) * 100)
            lines.append(f'<text x="20" y="{y}">{lang}: {pct}%</text>')
            y += 20

          lang_svg = f'''<svg xmlns="http://www.w3.org/2000/svg" width="540" height="{y}">
            <style>.bg{{fill:#0b1020}} .txt{{font-family:Segoe UI, Arial; fill:#fff}}</style>
            <rect rx="10" width="100%" height="100%" class="bg"/>
            <g class="txt" font-size="14">{''.join(lines)}</g>
          </svg>'''
          open("top-langs.svg", "w").write(lang_svg)
          PY

      - name: Commit and push SVGs
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add github-stats.svg top-langs.svg
          git commit -m "Update GitHub stats SVGs" || echo "No changes"
          git push
